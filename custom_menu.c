#include <n3310lcd.c> 


//***************************************************
#define IconSize 3   //не должен быть нулем! минимум 1
#define TankCapacity 55 //объем бензобака
#define MinEngineTemperature 0  //минимальная температура двигателя для отображения
#define MaxEngineTemperature 150 //максимальная температура двигателя для отображения
#define EngineTemperatureWarning 100 //температура при которой сработает предупреждение
#define MaxBaseTemperature 99 //максимальная температура для отображения (в салоне/снаружи)
#define MinBaseTemperature -50 //минимальная температура для отображения (в салоне/снаружи)
#define OutTemperatureWarning 3 //температура при которой появится предупреждение о гололеде
#define MinBatteryCurrent 100 //минимальное напряжение ниже которой появится предупреждение(Вольт*10)
#define MaxBatteryCurrent 148 //максимальное предупреждение выше которой появится предупреждение(Вольт*10)
#define BtnPort PINB.6  //порт на которой "висит" кнопка
#define PulsesAmount 1   //кол-во импульсов с датчика скорости за 1м пройденного пути

int _outTemperature,_internalTemperature,_engineTemperature;
unsigned char outTempDevice=1, internalTempDevice=2, engineTempDevice=0;

// maximum number of DS1820 devices
// connected to the 1 Wire bus
#define MAX_DS18B20 3
// number of DS1820 devices
// connected to the 1 Wire bus
unsigned char ds18b20_devices;
// DS1820 devices ROM code storage area,
// 9 bytes are used for each device
// (see the w1_search function description in the help)
unsigned char ds18b20_rom_codes[MAX_DS18B20][9];
unsigned int _arrTemplate[] = {0,1,2,3,4};
unsigned int _template;
float _volt;
unsigned int _btnCounter, _tempCounter;;
unsigned int _arrsize = sizeof(_arrTemplate)/sizeof(_arrTemplate[0]);
unsigned int _speed;
unsigned int _tacho;
unsigned int _speedTimerOverflow;
unsigned int _tachoTimerOverflow;
unsigned int _speedoPulsesOldValue;
unsigned int _tachoPulsesOldValue;


//ASCII
flash char pic1[] = 
{
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xFC,0x04,0x04,0x04,0xFC,
0x08,0x08,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xFC,
0x04,0x04,0xFC,0x20,0x20,0x00,
0x00,0xFF,0x00,0x00,0x00,0xFF,
0x02,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x40,0x40,0x40,0xFF,
0x00,0x00,0xFF,0x04,0x04,0x00,
0x00,0xFF,0x00,0x00,0x00,0xFF,
0x81,0x01,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x10,0x10,0x92,0xFF,
0x00,0x00,0xFF,0x00,0x00,0x00,
0x00,0x7F,0x40,0x40,0x40,0x7F,
0x10,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x04,0x04,0x24,0xFF,
0x00,0x00,0xFF,0x00,0x00,0x00,
0x80,0xFF,0xF9,0xF9,0xF9,0xFF,
0x90,0x22,0x3C,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x1C,0x3E,0x7F,0xF7,
0x81,0xB7,0xFD,0x7F,0x3E,0x1C
}; // FF


flash char icon[] = 
{
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, //00 //test
0xFF,0x81,0xFD,0x91,0xFD,0x81,0xB9,0xC5,0xC5,0xB9,0x81,0x85,0xFD,0x85,0x81,0xDD,0x81,0xFF,// 01//hot
0x00,0xFE,0x82,0x93,0x93,0x92,0x82,0x82,0x82,0x82,0x92,0xBB,0x93,0x82,0xFE,0x00,0x00,0x00,// 02//bat
0x00,0xFF,0x81,0xDD,0x81,0xFF,0x00,0x49,0x2A,0x1C,0x7F,0x1C,0x2A,0x49,0x00,0x00,0x00,0x00,// 03//ace
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 04//blank
0x00,0x7E,0x04,0x18,0x20,0x7E,0x00,0x3C,0x42,0x42,0x42,0x3C,0x00,0x7E,0x12,0x32,0x4C,0x00,// 05//nor
0x7E,0x04,0x08,0x04,0x7E,0x00,0x78,0x14,0x12,0x14,0x78,0x00,0x7E,0x40,0x40,0x40,0x00,0x00,// 06//mal
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x08,0x08,0x7E,0x00,0x7A,0x00,0x3C,0x42,// 07//hi
0x52,0x34,0x00,0x7E,0x08,0x08,0x7E,0x00,0x00,0x5E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 08//gh
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x40,0x40,0x40,0x00,0x3C,0x42,0x42,0x42,// 09//lo
0x3C,0x00,0x7E,0x20,0x10,0x20,0x7E,0x00,0x00,0x5E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 10//w!
};

void baseTemplate(unsigned int TankLevel, int EngineTemperature)
{
    float TemperatureProcent, TankProcent;

    if (EngineTemperature > MaxEngineTemperature)   EngineTemperature =  MaxEngineTemperature;
    if (EngineTemperature < MinEngineTemperature)   EngineTemperature =  MinEngineTemperature;
    sprintf (lcd_buf, "%3u", EngineTemperature);
    LcdString(12,1);
    sprintf (lcd_buf, "%u", TankLevel);
    LcdString(1,1);
    TemperatureProcent = (long)EngineTemperature*100/MaxEngineTemperature; 
    LcdBar(78, 10, 79, 39, TemperatureProcent);       
    TankProcent = (long)TankLevel*100/TankCapacity;
    LcdBar(2, 10, 4, 37, TankProcent);
}

void tempDeviceInit(void)
{
    unsigned int i;

    ds18b20_devices=w1_search(0xf0,ds18b20_rom_codes);
    
    for (i=0; i<ds18b20_devices; i++)
    {
        ds18b20_init(&ds18b20_rom_codes[i][0],-30,125,DS18B20_9BIT_RES);
    }
}

void getTemperature(unsigned int devices)
{

    switch (devices)
    {
        case 3:
            _internalTemperature =  ds18b20_temperature(&ds18b20_rom_codes[internalTempDevice][0]);
        case 2:
            _outTemperature =  ds18b20_temperature(&ds18b20_rom_codes[outTempDevice][0]);
        case 1:
            _engineTemperature = ds18b20_temperature(&ds18b20_rom_codes[engineTempDevice][0]);
    }; 
}

void iconView (int ch, unsigned int inv)
{
    CharPrint(ch,6*IconSize,icon,inv,0);
}

void iconClear (void)
{
    LcdGotoXYFont(3,1);
    CharPrint(4,6*IconSize,icon,0,0);
    CharPrint(4,6*IconSize,icon,0,0);
    CharPrint(4,6*IconSize,icon,0,0);
}

int tempProcessing(int temperature)
{
  if (temperature > MaxBaseTemperature) temperature = MaxBaseTemperature;
  if (temperature < MinBaseTemperature) temperature = MinBaseTemperature;
  return temperature;
}

void readADC(unsigned int adcValue)
{
  _volt = adcValue*0.14663; 
}

void checkBatState(void)
{
    unsigned int xPos;
    
    if ((int)_volt < 130) xPos = 9;  //low
    if ((int)_volt < 145 && (int)_volt >= 130) xPos = 5; //normal
    if ((int)_volt >= 145) xPos = 7;  //high
    LcdGotoXYFont(5,5);
    iconView(xPos,1);
    LcdGotoXYFont(8,5);
    iconView(xPos+1,1);  
}

void template(unsigned int numTemplate)
{
    int internalTemperature;
    int outTemperature; 
    
    switch (numTemplate)     
    {
        case 0: //temperature template
            internalTemperature = tempProcessing(_internalTemperature);
            outTemperature = tempProcessing(_outTemperature);
            LcdGotoXYFont(3,2);
	        LcdChrBold(0x03);
            LcdGotoXYFont(3,4);
	        LcdChrBold(0x04);  
            sprintf (lcd_buf, "%3i\x02", _engineTemperature);
            LcdStringBold(5,2);
            //sprintf (lcd_buf, "%3i\x02", internalTemperature);
            sprintf (lcd_buf, "%3i\x02", outTemperature);
            LcdStringBold(5,4);
            sprintf (lcd_buf, "Thermo");
	        LcdString(5,6);
            break;
        case 1:
            sprintf (lcd_buf, "%2i.%iV", (int)_volt/10, (int)_volt%10);
            LcdStringBold(3,3);
            checkBatState();
            sprintf (lcd_buf, "Voltmeter");
	        LcdString(3,6);
            break;
        case 2:
            sprintf (lcd_buf, "%3i", _speed);
            LcdStringBold(4,3);
            sprintf (lcd_buf, "Km/h");
            LcdString(6,5);
            sprintf (lcd_buf, "Speedo");
	        LcdString(4,6);
            break;
        case 3:
            sprintf (lcd_buf, "Ебашит:");
            LcdString(5,2);
            sprintf (lcd_buf, "%i", ds18b20_devices);
            LcdString(8,3);
            sprintf (lcd_buf, "датчика");
            LcdString(5,4);          
            sprintf (lcd_buf, "проебанно:", 3 - ds18b20_devices);
            LcdString(3,5);
            sprintf (lcd_buf, "%i", 3 - ds18b20_devices);
            LcdString(8,6);
            break;
        case 4:
            sprintf (lcd_buf, "%i.%i", _tacho/1000, (_tacho%1000)/100);
            LcdStringBold(5,3);
            sprintf (lcd_buf, "rpm/m");
            LcdString(5,5);
            sprintf (lcd_buf, "Tacho");
	        LcdString(5,6);
            break;
    } 
}

void setTemplate(unsigned int numTemplate)
{
    _template = numTemplate;
    LcdClear();
    LcdImage(pic1); 
    //template(numTemplate);
}

void warning(void)
{
  iconClear();
  if (_engineTemperature >= EngineTemperatureWarning)
  {
    LcdGotoXYFont(3,1);
    iconView(1,0);
  }
  
  if (_outTemperature <= OutTemperatureWarning)
  {
    LcdGotoXYFont(9,1);
    iconView(3,0);
  }
  
  if (_volt <= MinBatteryCurrent || _volt >= MaxBatteryCurrent)
  {
    LcdGotoXYFont(6,1);
    iconView(2,0);
  }
  
    
}

void update(void)
{
    baseTemplate(43,_engineTemperature);
    template(_template);
    warning(); 
    LcdUpdate(); 
}

void nextTemplate(void)
{
    setTemplate(_arrTemplate[_tempCounter]);
    _tempCounter++;
    if (_tempCounter > _arrsize-1) _tempCounter = 0; 
}

unsigned int getPulses (unsigned int *overflow, unsigned int *oldValue)
{
    unsigned int pulses, timerValue;
    unsigned int tH_buff, tL_buff;
    
    

    #asm("cli")
    tL_buff=TCNT1L;
    tH_buff=TCNT1H;
    #asm("sei")
    timerValue = (tH_buff*256)+tL_buff;
    
    if (overflow)
    {
        pulses = (65535*(*overflow) - (*oldValue)) + timerValue;
        *overflow = 0;
    }else{
        pulses = timerValue - (*oldValue);
    }
    *oldValue = timerValue;
    return pulses;
}

void speedo(unsigned int timerState)
{

    if (timerState && _speed > 0)
    {     
        _speedTimerOverflow++;
        return;
    }

    _speed = (((125000/getPulses(&_speedTimerOverflow, &_speedoPulsesOldValue))/PulsesAmount)*36)/10;
}

void tacho (unsigned int timerState)
{
    if (timerState && _tacho > 0)
        {     
            _tachoTimerOverflow++;
            return;
        }

    _tacho = ((125000/getPulses(&_tachoTimerOverflow, &_tachoPulsesOldValue))*60)/4;
}

void buttonCtrl (void)
{
    if (BtnPort == 0)
    {
        delay_ms(20);
        _btnCounter++;
    }else{
        if(_btnCounter>0){
            nextTemplate();
            _btnCounter = 0;
        }
    }
}

